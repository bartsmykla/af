name: "Release New Version"

on:
  workflow_dispatch: {}

  push:
    tags: ["v*.*.*"]

  pull_request: {}

permissions:
  contents: read

jobs:
  release:
    runs-on: ubuntu-24.04

    steps:
    - name: "Checkout"
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: "Generate GitHub App Token"
      id: github-app-token
      uses: actions/create-github-app-token@3ff1caaa28b64c9cc276ce0a02e2ff584f3900c5 # v2.0.2
      with:
        app-id: ${{ secrets.APP_ID }}
        private-key: ${{ secrets.APP_PRIVATE_KEY }}

    - name: "Get last bump version workflow run"
      id: get-last-workflow-run-id
      env:
        WORKFLOW_BUMP_VERSION: bump-version.yaml
        GH_TOKEN: ${{ steps.github-app-token.outputs.token }}
      run: |
        echo "id=$(
          gh run list \
            --workflow "$WORKFLOW_BUMP_VERSION" \
            --limit 1 \
            --json databaseId \
            --jq '.[] | .databaseId'
        )" >> "$GITHUB_OUTPUT"

    - name: "Get artifacts"
      uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
      with:
        github-token: ${{ steps.github-app-token.outputs.token }}
        run-id: ${{ steps.get-last-workflow-run-id.outputs.id }}
        path: dist

    - name: "Initialize Debug Shell"
      env:
        TUNSHELL_SECRET: ${{ secrets.TUNSHELL_SECRET }}
      run: .github/scripts/debug-shell.bash
